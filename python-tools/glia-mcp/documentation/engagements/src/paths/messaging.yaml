---
send_message:
  summary: Send message
  tags:
    - Secure conversations
  # yamllint disable rule:line-length
  description: |
    Initiates a secure conversation. Queues an async secure message and creates a messaging queue ticket.

    If the secure conversation had already been initiated and the engagement request already exists then the new message will just be queued.

    The `message_id` in the URL must be a version 4 UUID and needs to be generated by the requester.

    The endpoint is idempotent and repeated calls with the same `message_id` will produce the same result.


    ### Authorization and Permissions

    [Visitor's bearer access token](https://docs.glia.com/glia-dev/reference/post_visitors) - Requires all of the following:

    * The visitor is authenticated. See: <a href="https://docs.glia.com/glia-support/docs/authentication" target="authentication">Authentication</a>
    * The visitor has no ongoing engagements with an operator. See: <a href="https://docs.glia.com/glia-how-to/docs/secure-conversations" target="secure-conversations">Secure Conversations</a>

  # yamllint enable rule:line-length
  parameters:
    - $ref: '../parameters/engagements.yaml#/message_id'
  requestBody:
    required: true
    content:
      application/json:
        schema:
          $ref: '../schemas/messaging_message.yaml#/schema'
        examples:
          $ref: '../schemas/messaging_message.yaml#/examples'
  responses:
    '200':
      description: OK
    '401':
      $ref: '../../../common_components/responses/errors.yaml#/401_unauthorized'
    '403':
      $ref: '../../../common_components/responses/errors.yaml#/403_forbidden'
    '500':
      $ref: '../../../common_components/responses/errors.yaml#/500_internal_server_error'

fetch_transcript:
  summary: Fetch transcript
  tags:
    - Secure conversations
  # yamllint disable rule:line-length
  description: |
    Fetches the transcripts of the queued messages and past engagements of the authenticated visitor without requiring the visitor to be in an engagement.

    The endpoint does not support pagination and all available transcripts will be returned.

    The visitor can see:

    * their queued messages,
    * transcripts of all engagement legs they have participated in while authenticated,
    * the responses sent to them while being offline.

    Note that when a message contains a `files` type attachment, the attachment includes file name, content type, and URL. The URL to get the file requires the same authorization as fetching the transcript.

    For more information, see <a href="https://docs.glia.com/glia-how-to/docs/secure-conversations" target="secure-conversations">Secure Conversations</a>.

    ### Authorization and Permissions

    [Visitor's bearer access token](https://docs.glia.com/glia-dev/reference/post_visitors), requires:

    * The visitor is authenticated. See: <a href="https://docs.glia.com/glia-support/docs/authentication" target="authentication">Authentication</a>

  # yamllint enable rule:line-length
  responses:
    '200':
      description: |
        OK

        Transcript was successfully retrieved.
      content:
        application/vnd.salemove.v1+json:
          schema:
            $ref: '../schemas/transcript.yaml#/schema'
          examples:
            $ref: '../schemas/transcript.yaml#/examples'
    '401':
      $ref: '../../../common_components/responses/errors.yaml#/401_unauthorized'
    '403':
      $ref: '../../../common_components/responses/errors.yaml#/403_forbidden'
    '500':
      $ref: '../../../common_components/responses/errors.yaml#/500_internal_server_error'

mark_messages_read:
  summary: Mark messages read
  tags:
    - Secure conversations
  # yamllint disable rule:line-length
  description: |
    Marks all the visitor's secure messages as read.

    Note that all the messages sent to the visitor are considered unread until this endpoint is called. Sending a new message to the visitor sets the messages unread again.


    ### Authorization and Permissions

    [Visitor's bearer access token](https://docs.glia.com/glia-dev/reference/post_visitors) - Requires all of the following:

    * The visitor is authenticated. See: <a href="https://docs.glia.com/glia-support/docs/authentication" target="authentication">Authentication</a>
    * The visitor has no ongoing engagements with an operator. See: <a href="https://docs.glia.com/glia-how-to/docs/secure-conversations" target="secure-conversations">Secure Conversations</a>

  # yamllint enable rule:line-length
  responses:
    '200':
      description: OK

upload_file:
  summary: Upload file
  tags:
    - Secure conversations
  # yamllint disable rule:line-length
  description: |
    Uploads a file that can be sent as a part of a message later.

    The response contains a field `security_scanning_required`. If the value of this field is `true`, the uploader must wait for the [FileSecurityScanResultEvent](https://docs.glia.com/glia-dev/reference/webhooks#filesecurityscanresultevent) to arrive before they can send the file as a part of a message. Additionally, the scan result must be clean in order to send the file.


    ### Authorization and Permissions

    To use this endpoint, a user's or visitor's bearer access token is needed in the `Authorization` request header.

    * [User's bearer access token](https://docs.glia.com/glia-dev/reference/post_operator-authentication-tokens) - For operator to upload a file. Requires:

      * Base of the user's role, one of:
        * `operator`
        * `manager`
        * `super_manager`

    * [Visitor's bearer access token](https://docs.glia.com/glia-dev/reference/post_visitors) - For visitor to upload a file. Requires all of the following:
      * The visitor is authenticated. See: <a href="https://docs.glia.com/glia-support/docs/authentication" target="authentication">Authentication</a>
      * The visitor has no ongoing engagements with an operator. See: <a href="https://docs.glia.com/glia-how-to/docs/secure-conversations" target="secure-conversations">Secure Conversations</a>

    For more information about bearer access tokens, see [Authorization Header](https://docs.glia.com/glia-dev/reference/authorization-header).
  # yamllint enable rule:line-length
  requestBody:
    required: true
    content:
      multipart/form-data:
        $ref: '../schemas/file_upload.yaml#/upload_messaging_file'
  responses:
    '200':
      description: |
        OK

        File is uploaded and security scanning has been started.
      content:
        application/vnd.salemove.v1+json:
          schema:
            $ref: '../schemas/file_upload_response.yaml'
    '401':
      $ref: '../../../common_components/responses/errors.yaml#/401_unauthorized'
    '403':
      $ref: '../../../common_components/responses/errors.yaml#/403_forbidden'
    '500':
      $ref: '../../../common_components/responses/errors.yaml#/500_internal_server_error'

download_file:
  summary: Fetch file
  tags:
    - Secure conversations
  # yamllint disable rule:line-length
  description: |
    Downloads a file that is not part of an engagement.
    For example, the file has been sent as a part of a queued message.

    Returns either the contents of the file or a download URL depending on the `Accept` header:

    * `application/vnd.salemove.v1+json` - returns a JSON response containing `file_url`, which is a temporary file
    download URL that expires after a short while.
    * `*/*` - (default) returns the contents of the requested file.

    For more information, see <a href="https://docs.glia.com/glia-how-to/docs/secure-conversations" target="secure-conversations">Secure Conversations</a>.


    ### Authorization and Permissions

    [Visitor's bearer access token](https://docs.glia.com/glia-dev/reference/post_visitors) - For visitor to download a file, requires:

    * The visitor is authenticated. See: <a href="https://docs.glia.com/glia-support/docs/authentication" target="authentication">Authentication</a>
  # yamllint enable rule:line-length
  parameters:
    - $ref: '../parameters/engagements.yaml#/file_id'
  responses:
    '200':
      description: OK
      content:
        application/vnd.salemove.v1+json:
          schema:
            $ref: '../schemas/file_download_response.yaml#/temporary_link'
          examples:
            $ref: '../schemas/file_download_response.yaml#/temporary_link_example'
        '*/*':
          schema:
            $ref: '../schemas/file_download_response.yaml#/file'
    '401':
      $ref: '../../../common_components/responses/errors.yaml#/401_unauthorized'
    '403':
      $ref: '../../../common_components/responses/errors.yaml#/403_forbidden'
    '500':
      $ref: '../../../common_components/responses/errors.yaml#/500_internal_server_error'
