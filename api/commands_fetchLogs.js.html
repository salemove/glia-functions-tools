<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>JSDoc: Source: commands/fetchLogs.js</title>

    <script src="scripts/prettify/prettify.js"> </script>
    <script src="scripts/prettify/lang-css.js"> </script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>

<body>

<div id="main">

    <h1 class="page-title">Source: commands/fetchLogs.js</h1>

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>/**
 * Command to fetch logs for a function
 *
 * This command retrieves logs for a specified function
 */
import fs from 'fs/promises';
import { getApiConfig } from '../lib/config.js';
import GliaApiClient from '../lib/api.js';
import BaseCommand from '../cli/base-command.js';

/**
 * Fetch all logs for a function by following pagination
 * 
 * @param {Object} api - GliaApiClient instance
 * @param {string} functionId - Function ID
 * @param {Object} logsOptions - Logs filtering options
 * @param {boolean} showProgress - Whether to show progress information
 * @param {BaseCommand} [command] - BaseCommand instance for logging (optional)
 * @returns {Promise&lt;Array>} All log entries
 */
async function fetchAllLogs(api, functionId, logsOptions, showProgress, command) {
  let allLogs = [];
  let nextPage = null;
  let pageCount = 0;
  
  // Initial fetch
  const initialResult = await api.getFunctionLogs(functionId, logsOptions);
  
  // Add logs from first page
  if (initialResult.logs &amp;&amp; initialResult.logs.length > 0) {
    allLogs = [...initialResult.logs];
  }
  
  // Check if there are more pages
  nextPage = initialResult.next_page;
  pageCount = 1;

  if (showProgress &amp;&amp; command) {
    command.info(`Fetched page ${pageCount} with ${initialResult.logs ? initialResult.logs.length : 0} entries...`);
  }
  
  // Follow pagination and collect all logs
  while (nextPage) {
    // Use absolute URL for next page as provided by the API
    const nextPageResult = await api.makeRequest(nextPage, {}, {
      useCache: false, // Don't cache pagination requests
      useRetry: true   // But do retry if needed
    });
    
    pageCount++;
    
    if (showProgress &amp;&amp; command) {
      command.info(`Fetched page ${pageCount} with ${nextPageResult.logs ? nextPageResult.logs.length : 0} entries...`);
    }
    
    // Add logs from this page
    if (nextPageResult.logs &amp;&amp; nextPageResult.logs.length > 0) {
      allLogs = [...allLogs, ...nextPageResult.logs];
    }
    
    // Update next page URL for next iteration
    nextPage = nextPageResult.next_page;
  }
  
  return allLogs;
}

/**
 * Fetch logs for a function
 * 
 * @param {Object} options - Command options
 * @param {string} options.functionId - Function ID
 * @param {Object} options.logsOptions - Logs filtering options
 * @param {string} options.outputPath - Path to save logs (optional)
 * @param {boolean} options.fetchAll - Whether to fetch all logs (follow pagination)
 * @param {BaseCommand} [options.command] - BaseCommand instance for logging (optional)
 * @returns {Promise&lt;Object>} Logs data
 */
export async function fetchLogs(options) {
  try {
    // Get API configuration
    const apiConfig = await getApiConfig();
    
    // Create API client
    const api = new GliaApiClient(apiConfig);
    
    let result;
    
    if (options.fetchAll) {
      // Fetch all pages of logs
      const allLogs = await fetchAllLogs(
        api, 
        options.functionId, 
        options.logsOptions, 
        true, 
        options.command
      );
      
      result = {
        logs: allLogs,
        next_page: null // No more pages to fetch
      };
    } else {
      // Fetch just the first page
      result = await api.getFunctionLogs(options.functionId, options.logsOptions);
    }
    
    // Write to file if specified
    if (options.outputPath) {
      await fs.writeFile(options.outputPath, JSON.stringify(result, null, 2));
    }
    
    return result;
  } catch (error) {
    throw error;
  }
}

/**
 * Command handler when run directly from CLI
 */
async function main() {
  const command = new BaseCommand('fetch-logs', 'Fetch logs for a function')
    .requiredOption('--function-id &lt;id>', 'Function ID')
    .option('--limit &lt;count>', 'Maximum number of logs to retrieve per page', 100)
    .option('--start-time &lt;time>', 'Start time for logs (ISO 8601 format)')
    .option('--end-time &lt;time>', 'End time for logs (ISO 8601 format)')
    .option('--output &lt;path>', 'File path to save logs', './logs.json')
    .option('--all', 'Fetch all logs (follows pagination)', false)
    .action(async (options) => {
      command.info(`Fetching logs for function ${options.functionId}...`);
      
      const result = await fetchLogs({
        functionId: options.functionId,
        logsOptions: {
          limit: parseInt(options.limit, 10),
          startTime: options.startTime,
          endTime: options.endTime
        },
        outputPath: options.output,
        fetchAll: options.all,
        command: command // Pass command for progress reporting
      });
      
      if (options.output) {
        command.success(`Logs saved to ${options.output}`);
      }
      
      if (!result.logs || result.logs.length === 0) {
        command.info('No logs found for this function.');
        return;
      }
      
      command.info(`Found ${result.logs.length} log entries.`);
      
      // Check if the results might be truncated and there were more logs
      if (!options.all &amp;&amp; result.next_page) {
        command.info(`Note: These are only the first ${result.logs.length} logs. Use --all flag to fetch all logs.`);
      }
      
      // Only display the first 100 logs in the table to avoid console overload
      const displayLimit = 100;
      if (result.logs.length > displayLimit) {
        command.info(`Showing first ${displayLimit} entries in the table. All logs are saved in the output file.`);
        
        // Format logs as a table (limited to displayLimit)
        const tableData = result.logs.slice(0, displayLimit).map(log => ({
          'Timestamp': new Date(log.timestamp).toLocaleString(),
          'Message': log.message
        }));
        
        console.log(command.formatTable(tableData));
      } else {
        // Format all logs as a table
        const tableData = result.logs.map(log => ({
          'Timestamp': new Date(log.timestamp).toLocaleString(),
          'Message': log.message
        }));
        
        console.log(command.formatTable(tableData));
      }
    });
    
  command.parse(process.argv);
}

// Run if called directly
if (import.meta.url === `file://${process.argv[1]}`) {
  main();
}

export default fetchLogs;
</code></pre>
        </article>
    </section>




</div>

<nav>
    <h2><a href="index.html">Home</a></h2><h3>Modules</h3><ul><li><a href="module-api.html">api</a></li><li><a href="module-config.html">config</a></li></ul><h3>Classes</h3><ul><li><a href="ApiError.html">ApiError</a></li><li><a href="AuthenticationError.html">AuthenticationError</a></li><li><a href="BaseCommand_BaseCommand.html">BaseCommand</a></li><li><a href="CircuitBreaker.html">CircuitBreaker</a></li><li><a href="ConfigurationError.html">ConfigurationError</a></li><li><a href="FunctionError.html">FunctionError</a></li><li><a href="GliaError.html">GliaError</a></li><li><a href="NetworkDetector.html">NetworkDetector</a></li><li><a href="NetworkError.html">NetworkError</a></li><li><a href="OfflineManager.html">OfflineManager</a></li><li><a href="OperationQueue.html">OperationQueue</a></li><li><a href="PersistentCacheStorage.html">PersistentCacheStorage</a></li><li><a href="RateLimitError.html">RateLimitError</a></li><li><a href="ResponseCache.html">ResponseCache</a></li><li><a href="ValidationError.html">ValidationError</a></li><li><a href="module-api.html">api</a></li></ul><h3>Global</h3><ul><li><a href="global.html#CLIAuth">CLIAuth</a></li><li><a href="global.html#CLIBuildMenu">CLIBuildMenu</a></li><li><a href="global.html#CLICreateProfile">CLICreateProfile</a></li><li><a href="global.html#CLIDeleteProfile">CLIDeleteProfile</a></li><li><a href="global.html#CLIDeployFunction">CLIDeployFunction</a></li><li><a href="global.html#CLIDevFunction">CLIDevFunction</a></li><li><a href="global.html#CLIFunctionDetailsMenu">CLIFunctionDetailsMenu</a></li><li><a href="global.html#CLIFunctionInvoke">CLIFunctionInvoke</a></li><li><a href="global.html#CLIFunctionLogs">CLIFunctionLogs</a></li><li><a href="global.html#CLIFunctionVersion">CLIFunctionVersion</a></li><li><a href="global.html#CLIFunctionVersions">CLIFunctionVersions</a></li><li><a href="global.html#CLIInitProject">CLIInitProject</a></li><li><a href="global.html#CLIListFunctions">CLIListFunctions</a></li><li><a href="global.html#CLIListProfiles">CLIListProfiles</a></li><li><a href="global.html#CLIMainMenu">CLIMainMenu</a></li><li><a href="global.html#CLIManageEnvVars">CLIManageEnvVars</a></li><li><a href="global.html#CLINewFunction">CLINewFunction</a></li><li><a href="global.html#CLINewVersion">CLINewVersion</a></li><li><a href="global.html#CLIProfileMenu">CLIProfileMenu</a></li><li><a href="global.html#CLISetup">CLISetup</a></li><li><a href="global.html#CLISwitchProfile">CLISwitchProfile</a></li><li><a href="global.html#CLIUpdateEnvironment">CLIUpdateEnvironment</a></li><li><a href="global.html#CLIUpdateFunction">CLIUpdateFunction</a></li><li><a href="global.html#DEFAULT_CACHE_CONFIG">DEFAULT_CACHE_CONFIG</a></li><li><a href="global.html#DEFAULT_OFFLINE_CONFIG">DEFAULT_OFFLINE_CONFIG</a></li><li><a href="global.html#DEFAULT_RETRY_CONFIG">DEFAULT_RETRY_CONFIG</a></li><li><a href="global.html#calculateBackoffDelay">calculateBackoffDelay</a></li><li><a href="global.html#createAndDeployVersion">createAndDeployVersion</a></li><li><a href="global.html#createBearerToken">createBearerToken</a></li><li><a href="global.html#createFromTemplate">createFromTemplate</a></li><li><a href="global.html#createFunction">createFunction</a></li><li><a href="global.html#createProjectFromTemplate">createProjectFromTemplate</a></li><li><a href="global.html#dev">dev</a></li><li><a href="global.html#displayRequestDetails">displayRequestDetails</a></li><li><a href="global.html#displayTroubleshootingHints">displayTroubleshootingHints</a></li><li><a href="global.html#displayValidationDetails">displayValidationDetails</a></li><li><a href="global.html#fetchAllLogs">fetchAllLogs</a></li><li><a href="global.html#fetchGfLogs">fetchGfLogs</a></li><li><a href="global.html#fetchLogs">fetchLogs</a></li><li><a href="global.html#formatEnvVars">formatEnvVars</a></li><li><a href="global.html#formatErrorForDisplay">formatErrorForDisplay</a></li><li><a href="global.html#getAllFilesInDir">getAllFilesInDir</a></li><li><a href="global.html#getProjectTemplate">getProjectTemplate</a></li><li><a href="global.html#getTemplate">getTemplate</a></li><li><a href="global.html#getTemplateDefaultVars">getTemplateDefaultVars</a></li><li><a href="global.html#getTemplateEnvVars">getTemplateEnvVars</a></li><li><a href="global.html#handleError">handleError</a></li><li><a href="global.html#initCommand">initCommand</a></li><li><a href="global.html#interactiveEnvVars">interactiveEnvVars</a></li><li><a href="global.html#invokeFunction">invokeFunction</a></li><li><a href="global.html#isRetryable">isRetryable</a></li><li><a href="global.html#listEnvVars">listEnvVars</a></li><li><a href="global.html#listFunctions">listFunctions</a></li><li><a href="global.html#listProjectTemplates">listProjectTemplates</a></li><li><a href="global.html#listTemplates">listTemplates</a></li><li><a href="global.html#listTemplatesCommand">listTemplatesCommand</a></li><li><a href="global.html#main">main</a></li><li><a href="global.html#makeApiRequest">makeApiRequest</a></li><li><a href="global.html#onInvoke">onInvoke</a></li><li><a href="global.html#parseAndValidateJson">parseAndValidateJson</a></li><li><a href="global.html#parseVariables">parseVariables</a></li><li><a href="global.html#replaceVariables">replaceVariables</a></li><li><a href="global.html#routeCommand">routeCommand</a></li><li><a href="global.html#runCLI">runCLI</a></li><li><a href="global.html#showDebug">showDebug</a></li><li><a href="global.html#showError">showError</a></li><li><a href="global.html#showInfo">showInfo</a></li><li><a href="global.html#showSuccess">showSuccess</a></li><li><a href="global.html#showWarning">showWarning</a></li><li><a href="global.html#sleep">sleep</a></li><li><a href="global.html#updateEnvVars">updateEnvVars</a></li><li><a href="global.html#updateFunction">updateFunction</a></li><li><a href="global.html#validateApiConfiguration">validateApiConfiguration</a></li><li><a href="global.html#validateDateString">validateDateString</a></li><li><a href="global.html#validateEnvironmentVariables">validateEnvironmentVariables</a></li><li><a href="global.html#validateFilePath">validateFilePath</a></li><li><a href="global.html#validateFunctionId">validateFunctionId</a></li><li><a href="global.html#validateFunctionName">validateFunctionName</a></li><li><a href="global.html#validateInput">validateInput</a></li><li><a href="global.html#validateTemplateVariables">validateTemplateVariables</a></li><li><a href="global.html#withRetry">withRetry</a></li></ul>
</nav>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc/jsdoc">JSDoc 4.0.4</a>
</footer>

<script> prettyPrint(); </script>
<script src="scripts/linenumber.js"> </script>
</body>
</html>
